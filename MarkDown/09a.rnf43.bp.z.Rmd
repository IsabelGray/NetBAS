---
title: "09.rnf43.bp.z.Rmd"
author: "HBG"
date: "11/1/2018"
output: html_document
---

```{r}
### this block perform z-score calculations
library("microbenchmark")
library("matrixStats")

GOcategory.file <- read.csv("../Data/human.bp.term.csv",header=TRUE, stringsAsFactors=F)
bp.go.cat <- GOcategory.file$GO.term
bp.dim <- length(bp.go.cat)
conn.dim <- 20
hspin <- matrix(as.numeric(unlist(read.table("human.rnf43.all.bp.txt", header=F, sep=","))), nrow=bp.dim, ncol=conn.dim)
obs <- c(hspin)

perm <- c()
for (i in 1:100) {
    name <- paste("ms02.human", "/", "rnf43.heatmap", "/", "ms02.", i, ".bp.matrix.csv", sep="")
    mat <- matrix(as.numeric(unlist(read.table(name, header=F, sep=","))), nrow=bp.dim, ncol=conn.dim)
    perm <- rbind(perm, c(mat))
}

mean <- colMeans(perm)
std <- colSds(perm)

zscore <- round((obs - mean)/std, 3)

z <- matrix(zscore, nrow=bp.dim, ncol=conn.dim)

write.table(z, file="human.rnf43.P.bp.z.csv", sep=",", row.names=F, col.names=F, quote=F)
```

```{r}
library('gplots')
z <- t(z)

rownames(z) <- c("Q1","Q2","Q3","Q4","Q5","Q6","Q7","Q8","Q9","Q10",
                 "Q11","Q12","Q13","Q14","Q15","Q16","Q17","Q18","Q19","Q20")

colnames(z) <- bp.go.cat

colors = c(seq(min(z),-10.1,length=100),seq(-9.9,9.9,length=100),seq(10.1,max(z),length=100))
#colors = c(seq(min(z), max(z), length=300))
my_palette <- colorRampPalette(c("blue2", "white", "red2"))(n = 299)

png(filename = "human.rnf43.P.bp.heatmap.png",width=6, height=5.5, res=1200, unit="in")
heatmap.2(z, col=my_palette, breaks=colors, Rowv=F,
          trace='none', offsetRow = 0, offsetCol = 0,
          xlab="Biological Process Terms", ylab="Quantiles of Bayesian Factors",
          margins = c(2,3.5), key.title = "Color Bar", key.xlab="Z-score", key.ylab=NA,
          revC = T,
          labCol = NA, #labRow =,
          #srtCol=45, adjCol=c(1,0),
          #lmat=rbind(c(0,3,4), c(2,1,0)), lwid=c(1.5,4,2),
          scale="none", dendrogram = "col", symbreaks=T, symm=F, symkey = F)
dev.off()

hm <- heatmap.2(z, col=my_palette, breaks=colors, Rowv=F,
          trace='none', offsetRow = 0, offsetCol = 0,
          xlab="Biological Process Terms", ylab="Quantiles of Bayesian Factors",
          margins = c(2,3.5), key.title = "Color Bar", key.xlab="Z-score", key.ylab=NA,
          revC = T,
          labCol = NA, 
          scale="none", dendrogram = "col", symbreaks=T, symm=F, symkey = F)
hc.col <- as.hclust(hm$colDendrogram)
pdf("human.rnf43.P.bp.tree.pdf", width=150, height=4,paper='special')
plot(hc.col, xlab="BP Terms", main="Z-scores, Hierachical Clustering", cex=.8)
dev.off()
```
#GO analysis
```{r}
library(GO.db)
bp.go.term.tree <- bp.go.cat[hc.col$order]
write.table(bp.go.term.tree, file="human.rnf43.P.bp.tree.go.csv", sep=",", col.names=F, row.names = F, quote=F)

##the terms 2:28 are the branch enriched in Q17-Q20 (especially Q19 and Q20), but suppressed in Q1-Q16
pair <- c("GO.ID", "GO.Term")
for (i in 2:28) {
  go.term <- as.character(bp.go.term.tree[i])
  detail <- Term(GOID(go.term))
  pair <- rbind(pair, c(go.term, detail))
}

pair

write.table(pair, file="human.rnf43.P.bp.branch2.csv", col.names=F, row.names=F, sep="\t", quote=F)

library(ggplot2)
branch2 <- data.frame(z[,hc.col$order[2:28]])
branch2

matplot(branch2, type="b", xlab="Quantiles", ylab="Z-score", pch=19)

pdf(file="human.rnf43.P.bp.branch2.zprofile.pdf",width=6, height=4, paper='special')
matplot(branch2, type="b", xlab="Quantiles", ylab="Z-score", pch=19)
dev.off()
```